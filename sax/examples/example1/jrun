#############################################################
#
# RUN SCRIPT FOR EXAMPLE 1 
#
#############################################################
#############################################################
# Path definitions
#############################################################
JOB="example1"

JOB_DIR="$EXAMPLES_DIR/$JOB"

PW_EXE="$DFT_BIN/pw.x"
PW_INPUT="$JOB_DIR/pw.in"
PW_OUTPUT="$JOB_DIR/pw.out"
PP_EXE="$DFT_BIN/pw_export.x"
PP_INPUT="$JOB_DIR/pp.in"
PP_OUTPUT="$JOB_DIR/pp.out"
SPECTRA_INPUT="$JOB_DIR/spectra.in"
SPECTRA_OUTPUT="$JOB_DIR/spectra.log"
SAX_EXE="$SAX_BIN/sax.x"

#############################################################

#############################################################
# generation of pwscf input file
#############################################################
cat << EOF > $PW_INPUT

&CONTROL
title="Sibulk"
calculation='scf',
restart_mode = 'from_scratch',
tprnfor=.t.,
PSEUDO_DIR='$PSEUDO_DIR/',
prefix='Sibulk',
/
 &SYSTEM
                       ibrav = 0,
                   celldm(1) = 10.2,
                         nat = 2,
                        ntyp = 1,
                     ecutwfc = 15.0 ,
			nosym=.true.,
                        nbnd = 36,
 /
 &ELECTRONS
 /
CELL_PARAMETERS cubic
-0.5	0.0	0.5
0.0	0.5	0.5
-0.5	0.5	0.0
ATOMIC_SPECIES
    Si    1.00000  Si.vbc.UPF
ATOMIC_POSITIONS crystal
Si      0.000000000     0.000000000     0.0000000000
Si	0.250000000	0.250000000	0.2500000000
K_POINTS crystal
   27
    0.166666667    0.166666667    0.166666667    0.037037037
    0.500000000    0.166666667    0.166666667    0.037037037
    0.833333333    0.166666667    0.166666667    0.037037037
    0.166666667    0.500000000    0.166666667    0.037037037
    0.500000000    0.500000000    0.166666667    0.037037037
    0.833333333    0.500000000    0.166666667    0.037037037
    0.166666667    0.833333333    0.166666667    0.037037037
    0.500000000    0.833333333    0.166666667    0.037037037
    0.833333333    0.833333333    0.166666667    0.037037037
    0.166666667    0.166666667    0.500000000    0.037037037
    0.500000000    0.166666667    0.500000000    0.037037037
    0.833333333    0.166666667    0.500000000    0.037037037
    0.166666667    0.500000000    0.500000000    0.037037037
    0.500000000    0.500000000    0.500000000    0.037037037
    0.833333333    0.500000000    0.500000000    0.037037037
    0.166666667    0.833333333    0.500000000    0.037037037
    0.500000000    0.833333333    0.500000000    0.037037037
    0.833333333    0.833333333    0.500000000    0.037037037
    0.166666667    0.166666667    0.833333333    0.037037037
    0.500000000    0.166666667    0.833333333    0.037037037
    0.833333333    0.166666667    0.833333333    0.037037037
    0.166666667    0.500000000    0.833333333    0.037037037
    0.500000000    0.500000000    0.833333333    0.037037037
    0.833333333    0.500000000    0.833333333    0.037037037
    0.166666667    0.833333333    0.833333333    0.037037037
    0.500000000    0.833333333    0.833333333    0.037037037
    0.833333333    0.833333333    0.833333333    0.037037037
EOF

#############################################################

#############################################################
# generation of pw_export.x input file
#############################################################
cat << EOF > $PP_INPUT
&inputpp
  prefix="Sibulk",
/
EOF
#############################################################

#############################################################
# generation of spectra.x input file
#############################################################
cat << EOF > $SPECTRA_INPUT

<input>
<sax_options
  calculation_kind = "RPA"
  start_from = "DFT"
  local_fields_effects="F"
  convert_from_pwscf="T"
  just_project_on_q_direction="F"
  convert_from_pwscf_file="Sibulk.export/index.xml"
  nbandmin = "1"
  nbandmax = "36"
  system_kind = "3D"
  q = "0 1 0"
  lorentzian_broadening="0.007"
  imaginary_axis = "F"
  omegamax = "2.2"
  nomega = "400"
  emax_polarizability = "0.6"
  nelec="8.0"
  output_format = "txt"
/>

<structure>
  <direct
    a1 = " -5.1 ,  0.0 ,  5.1"
    a2 = "  0.0 ,  5.1 , 5.1"
    a3 = "  -5.1 , 5.1 ,  0.0" />
</structure>

<atoms>
<types ntypes="1">
Si  "$PSEUDO_DIR/Si.vbc.UPF" 15.0
</types>
<positions natoms="2" units="bohr" alat="1.0">
Si      0.000000000     0.000000000     0.0000000000
Si      -2.55           2.55            2.55
</positions>
</atoms>

<kmesh>
<mesh nk="3 3 3" shift="0.5 0.5 0.5"/>
</kmesh>

</input>

EOF
#############################################################

#############################################################
# Run of pwscf, pw_export and spectra.x
#############################################################

$PARA_PREFIX $PARA_POSTFIX $PW_EXE < $PW_INPUT > $PW_OUTPUT

$PARA_PREFIX $PARA_POSTFIX $PP_EXE < $PP_INPUT > $PP_OUTPUT

$PARA_PREFIX $PARA_POSTFIX $SAX_EXE -code spectra << EOF
$SPECTRA_INPUT
$SPECTRA_OUTPUT
EOF
#############################################################

