#############################################################
#
# RUN SCRIPT FOR EXAMPLE 4
#
#############################################################
#############################################################
# Path definitions
#############################################################

JOB="example4"

JOB_DIR="$EXAMPLES_DIR/$JOB"

PW_EXE="$DFT_BIN/pw.x"
PW1_INPUT="$JOB_DIR/pw1.in"
PW1_OUTPUT="$JOB_DIR/pw1.out"
PW2_INPUT="$JOB_DIR/pw2.in"
PW2_OUTPUT="$JOB_DIR/pw2.out"
PP_EXE="$DFT_BIN/pw_export.x"
PP_INPUT="$JOB_DIR/pp.in"
PP_OUTPUT="$JOB_DIR/pp.out"
GW1_INPUT="$JOB_DIR/gw1.in"
GW1_OUTPUT="$JOB_DIR/gw1.log"
GW2_INPUT="$JOB_DIR/gw2.in"
GW2_OUTPUT="$JOB_DIR/gw2.log"
SAX_EXE="$SAX_BIN/sax.x"

#############################################################
#
#############################################################
# generation of pwscf input file with a shifted k-point grid
#############################################################

cat << EOF > $PW1_INPUT

&CONTROL
title="chain"
calculation='scf',
restart_mode = 'from_scratch',
tprnfor=.t.,
PSEUDO_DIR='$PSEUDO_DIR/',
prefix='chain',
/
 &SYSTEM
                       ibrav = 8,
                    celldm(1)=20, celldm(2) = 1.0000,
                   celldm(3) = 0.233349,
                         nat = 4,
                        ntyp = 2,
                     ecutwfc = 45.0 ,
                        nbnd = 32,
                        nosym=.true.,
 /
 &ELECTRONS
 /
ATOMIC_SPECIES
    C    1.00000  C.pz-vbc.UPF
    H    1.00000  H.pz-vbc.UPF
ATOMIC_POSITIONS bohr
C      0.000000000     0.000000000    -1.106970000
C      1.225187328     0.000000000     1.106976303
H     -2.035217982     0.000000000    -1.115497550
H      3.260405310     0.000000000     1.115503853
K_POINTS crystal 
 30
    0.000000000    0.000000000    0.016666667    0.033333333
    0.000000000    0.000000000    0.050000000    0.033333333
    0.000000000    0.000000000    0.083333333    0.033333333
    0.000000000    0.000000000    0.116666667    0.033333333
    0.000000000    0.000000000    0.150000000    0.033333333
    0.000000000    0.000000000    0.183333333    0.033333333
    0.000000000    0.000000000    0.216666667    0.033333333
    0.000000000    0.000000000    0.250000000    0.033333333
    0.000000000    0.000000000    0.283333333    0.033333333
    0.000000000    0.000000000    0.316666667    0.033333333
    0.000000000    0.000000000    0.350000000    0.033333333
    0.000000000    0.000000000    0.383333333    0.033333333
    0.000000000    0.000000000    0.416666667    0.033333333
    0.000000000    0.000000000    0.450000000    0.033333333
    0.000000000    0.000000000    0.483333333    0.033333333
    0.000000000    0.000000000    0.516666667    0.033333333
    0.000000000    0.000000000    0.550000000    0.033333333
    0.000000000    0.000000000    0.583333333    0.033333333
    0.000000000    0.000000000    0.616666667    0.033333333
    0.000000000    0.000000000    0.650000000    0.033333333
    0.000000000    0.000000000    0.683333333    0.033333333
    0.000000000    0.000000000    0.716666667    0.033333333
    0.000000000    0.000000000    0.750000000    0.033333333
    0.000000000    0.000000000    0.783333333    0.033333333
    0.000000000    0.000000000    0.816666667    0.033333333
    0.000000000    0.000000000    0.850000000    0.033333333
    0.000000000    0.000000000    0.883333333    0.033333333
    0.000000000    0.000000000    0.916666667    0.033333333
    0.000000000    0.000000000    0.950000000    0.033333333
    0.000000000    0.000000000    0.983333333    0.033333333
EOF
#################################################

#############################################################
# generation of pwscf input file with a shifted k-point grid
#############################################################

cat << EOF > $PW2_INPUT

&CONTROL
title="chain"
calculation='scf',
restart_mode = 'from_scratch',
tprnfor=.t.,
PSEUDO_DIR='$PSEUDO_DIR/',
prefix='chain',
/
 &SYSTEM
                       ibrav = 8,
                    celldm(1)=20, celldm(2) = 1.0000,
                   celldm(3) = 0.233349,
                         nat = 4,
                        ntyp = 2,
                     ecutwfc = 45.0 ,
                        nbnd = 32,
                        nosym=.true.,
 /
 &ELECTRONS
 /
ATOMIC_SPECIES
    C    1.00000  C.pz-vbc.UPF
    H    1.00000  H.pz-vbc.UPF
ATOMIC_POSITIONS bohr
C      0.000000000     0.000000000    -1.106970000
C      1.225187328     0.000000000     1.106976303
H     -2.035217982     0.000000000    -1.115497550
H      3.260405310     0.000000000     1.115503853
K_POINTS crystal 
 30
    0.000000000    0.000000000    0.000000000    0.033333333
    0.000000000    0.000000000    0.033333333    0.033333333
    0.000000000    0.000000000    0.066666667    0.033333333
    0.000000000    0.000000000    0.100000000    0.033333333
    0.000000000    0.000000000    0.133333333    0.033333333
    0.000000000    0.000000000    0.166666667    0.033333333
    0.000000000    0.000000000    0.200000000    0.033333333
    0.000000000    0.000000000    0.233333333    0.033333333
    0.000000000    0.000000000    0.266666667    0.033333333
    0.000000000    0.000000000    0.300000000    0.033333333
    0.000000000    0.000000000    0.333333333    0.033333333
    0.000000000    0.000000000    0.366666667    0.033333333
    0.000000000    0.000000000    0.400000000    0.033333333
    0.000000000    0.000000000    0.433333333    0.033333333
    0.000000000    0.000000000    0.466666667    0.033333333
    0.000000000    0.000000000    0.500000000    0.033333333
    0.000000000    0.000000000    0.533333333    0.033333333
    0.000000000    0.000000000    0.566666667    0.033333333
    0.000000000    0.000000000    0.600000000    0.033333333
    0.000000000    0.000000000    0.633333333    0.033333333
    0.000000000    0.000000000    0.666666667    0.033333333
    0.000000000    0.000000000    0.700000000    0.033333333
    0.000000000    0.000000000    0.733333333    0.033333333
    0.000000000    0.000000000    0.766666667    0.033333333
    0.000000000    0.000000000    0.800000000    0.033333333
    0.000000000    0.000000000    0.833333333    0.033333333
    0.000000000    0.000000000    0.866666667    0.033333333
    0.000000000    0.000000000    0.900000000    0.033333333
    0.000000000    0.000000000    0.933333333    0.033333333
    0.000000000    0.000000000    0.966666667    0.033333333
EOF
##################################################################
# CONVERSION
##################################################################

cat << EOF > $PP_INPUT
&inputpp
  prefix="chain",
/
EOF
##################################################################
# GW1 screening
##################################################################

cat << EOF > $GW1_INPUT

<input>
<sax_options
  calculation_kind = "GW"
  start_from = "DFT"
  gw_integration_method = "plasmon_pole"
  calc_plasmon_pole_parameters = "T"
  lorentzian_broadening = "0.007"
  plasmon_energy = "1.0"
  nbandmin = "1"
  nbandmax = "32"
  nelec    = "10.0"
  convert_from_pwscf="T"
  coulomb_div_treatment="vcut_ws"
  ecutvcut="0.7"
  convert_from_pwscf_file="chain.export/index.xml"
  system_kind="3D"
  calc_polarizability="T"
  cutoff_polarizability="6.0"
  calc_w="T"
  cutoff_fock="45.0"
/>
<structure>
  <direct
    a1 = " 20.00000 , 0.000000000 , 0.000000000"
    a2 = "  0.00000000 , 20.000000 , 0.000000000"
    a3 = "  0.00000000 , 0.00000000 , 4.66698" />
</structure>

<atoms>
<types ntypes="2">
C "$PSEUDO_DIR/C.pz-vbc.UPF" 45.0
H "$PSEUDO_DIR/H.pz-vbc.UPF" 45.0
</types>
<positions natoms="4" units="bohr" alat="1.00">
C      0.000000000     0.000000000    -1.106970000
C      1.225187328     0.000000000     1.106976303
H     -2.035217982     0.000000000    -1.115497550
H      3.260405310     0.000000000     1.115503853
</positions>
</atoms>

<kmesh>
<mesh nk="1 1 30" shift="0.0 0.0 0.5"/>
</kmesh>

</input>

EOF

##################################################################
# GW2 self-energy
##################################################################

cat << EOF > $GW2_INPUT
<input>
<sax_options
  calculation_kind = "GW"
  start_from = "DFT"
  gw_integration_method = "plasmon_pole"
  lorentzian_broadening = "0.007"
  plasmon_energy = "1.0"
  nbandmin = "1"
  nbandmax = "32"
  nelec    = "10.0"
  convert_from_pwscf="T"
  coulomb_div_treatment="vcut_ws"
  ecutvcut="0.7"
  convert_from_pwscf_file="chain.export/index.xml"
  system_kind="3D"
  cutoff_polarizability="6.0"
  cutoff_fock="45.0"
  calc_sigma_x="T"
  calc_sigma_c="T"
  calc_energies = "T"
  calc_sp_hmatrix = "T"
  sigma_nbmin = "4"
  sigma_nbmax = "7"
  diagonal = "T"
  sigma_first_order = "T"
/>
<structure>
  <direct
    a1 = " 20.00000 , 0.000000000 , 0.000000000"
    a2 = "  0.00000000 , 20.000000 , 0.000000000"
    a3 = "  0.00000000 , 0.00000000 , 4.66698" />
</structure>

<atoms>
<types ntypes="2">
C "$PSEUDO_DIR/C.pz-vbc.UPF" 45.0
H "$PSEUDO_DIR/H.pz-vbc.UPF" 45.0
</types>
<positions natoms="4" units="bohr" alat="1.00">
C      0.000000000     0.000000000    -1.106970000
C      1.225187328     0.000000000     1.106976303
H     -2.035217982     0.000000000    -1.115497550
H      3.260405310     0.000000000     1.115503853
</positions>
</atoms>

<kmesh>
<mesh nk="1 1 30" shift="0.0 0.0 0.0"/>
</kmesh>

</input>

EOF

#############################################################
# Running
#############################################################

$PARA_PREFIX $PARA_POSTFIX $PW_EXE < $PW1_INPUT > $PW1_OUTPUT

$PARA_PREFIX $PARA_POSTFIX $PP_EXE < $PP_INPUT > $PP_OUTPUT

$PARA_PREFIX $PARA_POSTFIX $SAX_EXE -code gw << EOF
$GW1_INPUT
$GW1_OUTPUT
EOF

$PARA_PREFIX $PARA_POSTFIX $PW_EXE < $PW2_INPUT > $PW2_OUTPUT

$PARA_POSTFIX $PARA_PREFIX $PP_EXE < $PP_INPUT > $PP_OUTPUT

$PARA_PREFIX $PARA_POSTFIX $SAX_EXE -code gw << EOF
$GW2_INPUT
$GW2_OUTPUT
EOF
